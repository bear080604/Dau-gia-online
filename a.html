<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Realtime ƒê·∫•u gi√°</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f3f4f6;
      padding: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .auction-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }
    .auction-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      position: relative;
    }
    .auction-card:hover {
      transform: scale(1.03);
      box-shadow: 0 4px 14px rgba(0,0,0,0.15);
    }
    .auction-card img {
      width: 100%;
      height: 180px;
      object-fit: cover;
    }
    .auction-card .info {
      padding: 12px;
    }
    .auction-card .info h3 {
      margin: 0 0 6px;
    }
    .auction-card .info p {
      font-size: 14px;
      color: #555;
      margin: 4px 0;
    }
    .badge {
      position: absolute;
      top: 8px;
      left: 8px;
      background: #3b82f6;
      color: white;
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>üî• S·∫£n ph·∫©m ƒë·∫•u gi√° (Realtime)</h1>
  <!-- Container ƒë·ªÉ hi·ªÉn th·ªã danh s√°ch s·∫£n ph·∫©m -->
  <div class="auction-list" id="auctionList"></div>

  <!-- Socket.io client -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    console.log("üìå Script loaded, DOM ready");

    // -----------------------------
    // 1Ô∏è‚É£ C·∫•u h√¨nh
    // -----------------------------
    const API_URL = "http://127.0.0.1:8000/api/products"; // API Laravel ƒë·ªÉ load d·ªØ li·ªáu ban ƒë·∫ßu
    const socket = io("http://127.0.0.1:6001"); // Node.js Socket.io server
    const auctionList = document.getElementById("auctionList");
    const auctions = new Map(); // L∆∞u s·∫£n ph·∫©m theo ID ƒë·ªÉ tr√°nh tr√πng

    console.log("auctionList element:", auctionList);

    // -----------------------------
    // 2Ô∏è‚É£ Load d·ªØ li·ªáu ban ƒë·∫ßu t·ª´ Laravel
    // -----------------------------
    async function loadInitial() {
      console.log("‚è≥ Fetching initial data from Laravel...");
      try {
        const res = await fetch(API_URL);
        const json = await res.json();

        // Laravel tr·∫£ v·ªÅ { data: [...] }
        let list = Array.isArray(json) ? json : json.data;
        if (!Array.isArray(list)) list = [json];

        auctionList.innerHTML = ""; // X√≥a UI c≈©
        list.forEach(addAuctionToUI); // Th√™m t·ª´ng s·∫£n ph·∫©m v√†o UI
        console.log("‚úÖ Initial fetch complete:", json);
      } catch (err) {
        console.error("‚ùå Error fetching initial data:", err);
      }
    }

    // -----------------------------
    // 3Ô∏è‚É£ Th√™m ho·∫∑c c·∫≠p nh·∫≠t s·∫£n ph·∫©m v√†o UI
    // -----------------------------
    function addAuctionToUI(a) {
      // Chu·∫©n h√≥a ID (item_id t·ª´ backend)
      if (!a.id && a.item_id) a.id = a.item_id;

      auctions.set(a.id, a); // L∆∞u v√†o Map
      let card = document.getElementById(`auction-${a.id}`);

      if (!card) {
        // N·∫øu ch∆∞a c√≥ th·∫ª, t·∫°o m·ªõi
        card = document.createElement("div");
        card.className = "auction-card";
        card.id = `auction-${a.id}`;
        card.innerHTML = `
          <div class="badge">NEW</div>
          <img src="${"http://127.0.0.1:8000"+a.image_url}" alt="${a.name}">
          <div class="info">
            <h3>${a.name}</h3>
            <p>${a.description}</p>
            <p><b>Gi√° kh·ªüi ƒëi·ªÉm:</b> ${Number(a.starting_price).toLocaleString()} VNƒê</p>
            <p><b>Tr·∫°ng th√°i:</b> ${a.status}</p>
            <p><i>Ng∆∞·ªùi ƒëƒÉng:</i> ${a.owner?.name ?? "Kh√¥ng r√µ"}</p>
          </div>
        `;
        auctionList.prepend(card); // Th√™m s·∫£n ph·∫©m m·ªõi l√™n ƒë·∫ßu danh s√°ch
      } else {
        // N·∫øu ƒë√£ c√≥, c·∫≠p nh·∫≠t th√¥ng tin
        card.querySelector(".info").innerHTML = `
          <h3>${a.name}</h3>
          <p>${a.description}</p>
          <p><b>Gi√° kh·ªüi ƒëi·ªÉm:</b> ${Number(a.starting_price).toLocaleString()} VNƒê</p>
          <p><b>Tr·∫°ng th√°i:</b> ${a.status}</p>
          <p><i>Ng∆∞·ªùi ƒëƒÉng:</i> ${a.owner?.name ?? "Kh√¥ng r√µ"}</p>
        `;
        const badge = card.querySelector(".badge");
        badge.textContent = "UPDATED";
        badge.style.background = "#16a34a"; // m√†u xanh l√°
      }
    }

    // -----------------------------
    // 4Ô∏è‚É£ Socket.io - K·∫øt n·ªëi v√† join channel
    // -----------------------------
    socket.on("connect", () => {
      console.log("‚ö° Socket connected:", socket.id);
      console.log("üì¢ Joining channel: auction-items");
      socket.emit("join.channel", "auction-items"); // Join ƒë√∫ng channel
    });

    // -----------------------------
    // 5Ô∏è‚É£ L·∫Øng nghe event realtime t·ª´ Node
    // -----------------------------
    socket.onAny((event, payload) => {
      console.log("‚ö° Event t·ª´ Node.js:", event, payload);

      // Node c√≥ th·ªÉ g·ª≠i { item: {...} } ho·∫∑c { data: { item: {...} } }
      const auction = payload.item || payload.data?.item;
      if (auction) {
        if (!auction.id && auction.item_id) auction.id = auction.item_id;
        addAuctionToUI(auction); // Th√™m ho·∫∑c c·∫≠p nh·∫≠t UI ngay
      }
    });

    // -----------------------------
    // 6Ô∏è‚É£ Load d·ªØ li·ªáu ban ƒë·∫ßu khi m·ªü trang
    // -----------------------------
    loadInitial();
  </script>
</body>
</html>
