<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh sách hồ sơ đấu giá</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .status {
            padding: 5px 10px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
        }
        .status.DaDuyet {
            background-color: #4CAF50;
        }
        .status.ChuaDuyet {
            background-color: #ff9800;
        }
        .status.TuChoi {
            background-color: #f44336;
        }
        button {
            padding: 8px 16px;
            margin: 2px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            font-weight: bold;
        }
        button.approve {
            background-color: #4CAF50;
        }
        button.reject {
            background-color: #f44336;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .loading {
            text-align: center;
            font-style: italic;
            color: #666;
        }
        .error {
            color: #f44336;
            text-align: center;
        }
        .na {
            color: #999;
            font-style: italic;
        }
        .last-updated {
            text-align: center;
            color: #666;
            font-size: 12px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>Danh sách hồ sơ đấu giá</h1>
    <div id="loading" class="loading">Đang tải dữ liệu...</div>
    <div id="error" class="error" style="display: none;"></div>
    <div id="lastUpdated" class="last-updated" style="display: none;"></div>
    <table id="profilesTable" style="display: none;">
        <thead>
            <tr>
                <th>ID Hồ sơ</th>
                <th>Tên vật phẩm</th>
                <th>Mô tả</th>
                <th>Giá khởi điểm</th>
                <th>Số tiền đặt cọc</th>
                <th>Trạng thái</th>
                <th>Hành động</th>
                <th>Ngày tạo</th>
            </tr>
        </thead>
        <tbody id="profilesBody">
        </tbody>
    </table>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        const profilesTable = document.getElementById('profilesTable');
        const profilesBody = document.getElementById('profilesBody');
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const lastUpdatedDiv = document.getElementById('lastUpdated');

        // Dữ liệu mẫu từ JSON cung cấp (có thể sử dụng để test nếu API không khả dụng)
        const sampleData = {
          "status": true,
          "message": "Danh sách hồ sơ đấu giá",
          "profiles": [
            {
              "profile_id": 1,
              "user_id": 1,
              "session_id": 1,
              "document_url": "hoso1.pdf",
              "deposit_amount": "50000000.00",
              "status": "DaDuyet",
              "created_at": "2025-10-01 10:40:08",
              "session": {
                "session_id": 1,
                "item_id": 1,
                "created_by": 2,
                "start_time": "2025-10-03T02:45:49.000000Z",
                "end_time": "2025-10-03T02:48:49.000000Z",
                "regulation": "Người 2",
                "status": "KetThuc",
                "method": "Đấu giá tự do",
                "auction_org_id": 6,
                "register_start": "2025-10-03T02:51:49.000000Z",
                "register_end": "2025-10-03T02:54:49.000000Z",
                "checkin_time": "2025-10-03T02:57:49.000000Z",
                "bid_start": "2025-10-03T10:51:00.000000Z",
                "bid_end": "2025-10-03T10:52:00.000000Z",
                "bid_step": "2000000.00"
              },
              "item": null
            }
          ]
        };

        async function fetchProfiles() {
            try {
                loadingDiv.style.display = 'block';
                errorDiv.style.display = 'none';
                const response = await fetch(`${API_BASE}/auction-profiles`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data.status) {
                    displayProfiles(data.profiles);
                } else {
                    throw new Error(data.message || 'Lỗi tải dữ liệu');
                }
            } catch (error) {
                console.error('Error fetching profiles:', error);
                errorDiv.textContent = `Lỗi: ${error.message}`;
                errorDiv.style.display = 'block';
                // Fallback to sample data if API fails
                console.log('Using sample data as fallback');
                if (sampleData.status) {
                    displayProfiles(sampleData.profiles);
                }
            }
        }

        function displayProfiles(profiles) {
            profilesBody.innerHTML = '';
            profiles.forEach(profile => {
                const row = document.createElement('tr');
                const statusClass = profile.status === 'DaDuyet' ? 'DaDuyet' : 
                                    profile.status === 'TuChoi' ? 'TuChoi' : 'ChuaDuyet';
                
                // Xử lý trường hợp item null
                const itemName = profile.item ? profile.item.name : 'N/A';
                const itemDesc = profile.item ? profile.item.description : 'N/A';
                const startingPrice = profile.item ? profile.item.starting_price : null;
                const startingPriceDisplay = startingPrice ? parseFloat(startingPrice).toLocaleString('vi-VN') + ' VNĐ' : 'N/A';
                
                const depositAmount = parseFloat(profile.deposit_amount).toLocaleString('vi-VN') + ' VNĐ';
                
                const approveBtn = profile.status === 'DaDuyet' ? 
                                   `<button class="approve" disabled>Đã duyệt</button>` : 
                                   `<button class="approve" onclick="updateStatus(${profile.profile_id}, 'DaDuyet')">Duyệt</button>`;
                const rejectBtn = profile.status === 'TuChoi' ? 
                                  `<button class="reject" disabled>Từ chối</button>` : 
                                  `<button class="reject" onclick="updateStatus(${profile.profile_id}, 'TuChoi')">Từ chối</button>`;

                row.innerHTML = `
                    <td>${profile.profile_id}</td>
                    <td class="${itemName === 'N/A' ? 'na' : ''}">${itemName}</td>
                    <td class="${itemDesc === 'N/A' ? 'na' : ''}">${itemDesc}</td>
                    <td class="${startingPriceDisplay === 'N/A' ? 'na' : ''}">${startingPriceDisplay}</td>
                    <td>${depositAmount}</td>
                    <td><span class="status ${statusClass}">${profile.status}</span></td>
                    <td>${approveBtn} ${rejectBtn}</td>
                    <td>${new Date(profile.created_at).toLocaleString('vi-VN')}</td>
                `;
                profilesBody.appendChild(row);
            });
            loadingDiv.style.display = 'none';
            profilesTable.style.display = 'table';
            lastUpdatedDiv.textContent = `Cập nhật lần cuối: ${new Date().toLocaleString('vi-VN')}`;
            lastUpdatedDiv.style.display = 'block';
        }

        async function updateStatus(profileId, newStatus) {
            try {
                const response = await fetch(`${API_BASE}/auction-profiles/${profileId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data.status) {
                    alert('Cập nhật trạng thái thành công!');
                    fetchProfiles(); // Reload data
                } else {
                    throw new Error(data.message || 'Lỗi cập nhật');
                }
            } catch (error) {
                console.error('Error updating status:', error);
                alert(`Lỗi: ${error.message}`);
            }
        }

        // Load data on page load
        fetchProfiles();

        // Real-time updates: Polling every 5 seconds
        setInterval(() => {
            fetchProfiles();
        }, 5000);
    </script>
</body>
</html>